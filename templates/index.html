<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grafik Zmian ‚Äî Logowanie</title>
  <link rel="stylesheet" href="/static/css/style.css" />
  <meta name="color-scheme" content="light dark" />
</head>
<body class="page-auth">
  <div class="auth-card">
    <h1 class="app-title">Grafik Zmian</h1>

    <!-- LOGIN -->
    <div id="login-view">
      <h2>Logowanie</h2>
      <form id="login-form" autocomplete="on">
        <label>Email
          <input type="email" name="email" id="login-email" required autocomplete="username" />
        </label>

        <label>Has≈Ço
          <span class="pass-wrap">
            <input id="login-pass" type="password" name="password" required autocomplete="current-password" />
            <button type="button" class="toggle-pass" aria-label="Poka≈º/ukryj has≈Ço">üëÅ</button>
          </span>
          <span id="login-caps" class="muted small" hidden>W≈ÇƒÖczony Caps Lock</span>
        </label>

        <div class="row between center" style="margin:6px 0 10px;">
          <label class="small muted">
            <input id="remember-me" type="checkbox" /> Zapamiƒôtaj mnie
          </label>
          <a href="#" id="change-pass-link" class="muted small">Zmie≈Ñ has≈Ço</a>
        </div>

        <button type="submit">Zaloguj</button>
        <p class="form-msg" id="login-msg"></p>
      </form>
      <p class="muted">
        Nie masz konta? <a href="#" id="to-register">Zarejestruj siƒô</a>
      </p>
    </div>

    <!-- REGISTER -->
    <div id="register-view" class="hidden">
      <h2>Rejestracja</h2>
      <form id="register-form" autocomplete="on">
        <label>Imiƒô i nazwisko
          <input type="text" name="full_name" required />
        </label>

        <label>Email
          <input type="email" name="email" required autocomplete="email" />
        </label>

        <label>Has≈Ço
          <span class="pass-wrap">
            <input id="reg-pass" type="password" name="password" required minlength="4" autocomplete="new-password" />
            <button type="button" class="toggle-pass" aria-label="Poka≈º/ukryj has≈Ço">üëÅ</button>
          </span>
          <div class="pwd-meter">
            <div id="pwd-bar"></div>
          </div>
          <div id="pwd-hint" class="small muted">
            U≈ºyj min. 8 znak√≥w i mieszaj: ma≈Çe/du≈ºe litery, cyfry, symbol.
          </div>
        </label>

        <button type="submit">Utw√≥rz konto</button>
        <p class="form-msg" id="register-msg"></p>
      </form>
      <p class="muted">
        Masz ju≈º konto? <a href="#" id="to-login">Zaloguj siƒô</a>
      </p>
    </div>
  </div>

  <!-- MODAL: Zmie≈Ñ has≈Ço -->
  <div id="change-pass-modal" class="modal hidden">
    <div class="modal-content">
      <h3>Zmie≈Ñ has≈Ço</h3>

      <label for="old-pass">Stare has≈Ço</label>
      <input type="password" id="old-pass" placeholder="Wpisz stare has≈Ço">

      <label for="new-pass">Nowe has≈Ço</label>
      <input type="password" id="new-pass" placeholder="Wpisz nowe has≈Ço">

      <div class="modal-buttons" style="margin-top: 12px; display: flex; justify-content: flex-end; gap: 10px;">
        <button id="change-cancel" class="btn-cancel">Anuluj</button>
        <button id="change-save" class="btn-primary">Zapisz</button>
      </div>
    </div>
  </div>

  <script src="/static/js/app.js?v=auth1"></script>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–æ–¥–∞–ª–∫–∏ –æ—Ç app.js (reset password)
    document.querySelectorAll('.modal-backdrop, .modal').forEach(n => {
      if (!n.id || n.id !== 'change-pass-modal') n.remove();
    });

    const modal = document.getElementById('change-pass-modal');
    const openBtn = document.getElementById('change-pass-link');
    const closeBtn = document.getElementById('change-cancel');
    const saveBtn = document.getElementById('change-save');
    const oldPass = document.getElementById('old-pass');
    const newPass = document.getElementById('new-pass');
    const emailInput = document.getElementById('login-email');

    const api = async (url, opts) => {
      const res = await fetch(url, Object.assign({headers:{'Content-Type':'application/json'}}, opts||{}));
      const body = await res.json().catch(()=>({}));
      if (!res.ok) throw new Error(body.error || 'B≈ÇƒÖd');
      return body;
    };

    openBtn?.addEventListener('click', e => {
      e.preventDefault();
      modal.classList.remove('hidden');
    });

    closeBtn?.addEventListener('click', () => modal.classList.add('hidden'));

    saveBtn?.addEventListener('click', async () => {
      const email = (emailInput?.value || '').trim();
      const stare = oldPass.value.trim();
      const nowe = newPass.value.trim();

      if (!email) return alert('Podaj email (w polu logowania).');
      if (!stare || !nowe) return alert('Wpisz stare i nowe has≈Ço.');

      try {
        await api('/api/password/change', {
          method: 'POST',
          body: JSON.stringify({ email, stare_haslo: stare, nowe_haslo: nowe })
        });
        alert('Has≈Ço zosta≈Ço zmienione pomy≈õlnie.');
        modal.classList.add('hidden');
        oldPass.value = '';
        newPass.value = '';
      } catch (e) {
        alert(e.message || 'B≈ÇƒÖd podczas zmiany has≈Ça.');
      }
    });
  });
  </script>

  <style>
    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
    }

    .modal-content {
      background: #1f1f1f;
      color: #fff;
      padding: 20px;
      border-radius: 12px;
      width: 320px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    .hidden {
      display: none;
    }

    .btn-cancel {
      background: transparent;
      border: 1px solid #888;
      color: #ccc;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    .btn-cancel:hover {
      border-color: #aaa;
      color: #fff;
    }

    .btn-primary {
      background: linear-gradient(90deg, #58c6ff, #77ffb3);
      border: none;
      color: #000;
      padding: 6px 14px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }

    .btn-primary:hover {
      opacity: 0.9;
    }
  </style>
</body>
</html>
